using System;
using System.Data.SqlClient;

namespace MSSQLTool.Utils
{
    class Enumerator
    {
        public static void enumerate(SqlConnection con)
        {
            String query = "SELECT SYSTEM_USER;";
            SqlCommand cmd = new SqlCommand(query, con);
            SqlDataReader reader = cmd.ExecuteReader();
            reader.Read();
            Console.WriteLine("[+] Logged in as: " + reader[0]);
            reader.Close();

            query = "SELECT USER_NAME();";
            cmd = new SqlCommand(query, con);
            reader = cmd.ExecuteReader();
            reader.Read();
            Console.WriteLine("[+] Mapped to user: " + reader[0]);
            reader.Close();

            query = "SELECT IS_SRVROLEMEMBER('public');";
            cmd = new SqlCommand(query, con);
            reader = cmd.ExecuteReader();
            reader.Read();
            Int32 role = Int32.Parse(reader[0].ToString());
            if (role == 1)
            {
                Console.WriteLine("[+] User is a member of public role");
            }
            reader.Close();

            query = "SELECT IS_SRVROLEMEMBER('sysadmin');";
            cmd = new SqlCommand(query, con);
            reader = cmd.ExecuteReader();
            reader.Read();
            role = Int32.Parse(reader[0].ToString());
            if (role == 1)
            {
                Console.WriteLine("[+] User is a member of sysadmin role");
            }
            reader.Close();

            query = "SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals " +
                "b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE';";
            cmd = new SqlCommand(query, con);
            reader = cmd.ExecuteReader();
            Console.WriteLine("Users that can be impersonated: ");
            while (reader.Read() == true)
            {
                Console.WriteLine("[+] " + reader[0]);
            }
            reader.Close();

            query = "SELECT name from  sys.databases";
            cmd = new SqlCommand(query, con);
            Console.WriteLine("All available databaes:");
            using (SqlDataReader r = cmd.ExecuteReader())
            {
                while (r.Read())
                {
                    Console.WriteLine("[+] " + r[0].ToString());
                }
                r.Close();
            }

            query = "SELECT * from sys.server_principals;";
            cmd = new SqlCommand(query, con);
            Console.WriteLine("All available users:");
            using (SqlDataReader r = cmd.ExecuteReader())
            {
                while (r.Read())
                {
                    Console.WriteLine("[+] " + r[0].ToString());
                }
                r.Close();
            }
            con.Close();
        }
    }
}
